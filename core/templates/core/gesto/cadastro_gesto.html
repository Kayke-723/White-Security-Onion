{% extends "core/base.html" %}
{% load static %}
{% block content %}

<head>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg_Ceu flex justify-center">
    <!-- T√çTULO CENTRAL -->
    <header class="left-7 flex justify-items-center relative gap-x-10">
        <a href="{% url 'index' %}"
            class="no-underline decoration-transparent hover:opacity-80 transition duration-200 inline-block"
            style="text-decoration: none !important;">
            <h1
                class="text-5xl font-bold text-white flex items-center justify-center gap-2 drop-shadow-[0_0_20px_rgba(255,255,255,0.3)]">
                White Security
                <span class="relative flex items-center">
                    <span class="opacity-0 select-none">O</span>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="none"
                        class="w-12 h-12 absolute left-0 top-1/2 -translate-y-1/2 animate-spin-slow">
                        <defs>
                            <linearGradient id="ringGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" stop-color="#ffffff" />
                                <stop offset="50%" stop-color="#c084fc" />
                                <stop offset="100%" stop-color="#ffffff" />
                            </linearGradient>
                        </defs>
                        <circle cx="50" cy="50" r="40" stroke="url(#ringGradient)" stroke-width="3" />
                        <path d="M50 15 Q75 35 50 55 Q25 75 50 95" stroke="url(#ringGradient)" stroke-width="2"
                            opacity="0.8" />
                        <path d="M50 25 Q70 40 50 55 Q30 70 50 85" stroke="url(#ringGradient)" stroke-width="1.5"
                            opacity="0.6" />
                    </svg>
                    <span class="ml-[0.5rem]">nion</span>
                </span>
            </h1>
        </a>

    </header>

    <!-- Planetas decorativos -->
    <div class="planet planet1"></div>
    <div class="planet planet2"></div>

    <div class="onionGesto video-container" style="margin-top: 100px;
    margin-left: 600px;">
        <video id="video" autoplay class="video-redondo"></video>
        <!-- Canvas para desenhar as linhas -->
        <canvas id="canvas" width="640" height="480"
            style="position:absolute; top:100px; left:600px; border-radius:50%;"></canvas>
    </div>

    <div class="bg_CeuMenu flex flex-col justify-items-center" style="
        bottom: 450px; 
        right: 400px;
        padding: 20px;
        border-radius: 20px;
        max-width: 700px;
        max-height: 700px;
        margin: 20px auto;
        border: 4px solid #3b82f6;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
        <!-- Campo Nome de Usu√°rio -->
        <div style="margin-bottom: 16px;">
            <label for="username" style="color: #ffffff; display: block; margin-bottom: 4px;">Nome de
                Usu√°rio:</label>
            <input type="text" id="username" name="username" placeholder="Digite aqui"
                class="border placeholder:text-gray-500 border-white rounded-2xl p-3 w-500px focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <!-- Campo Email -->
        <div style="margin-bottom: 16px;">
            <label for="email" style="color: #ffffff; display: block; margin-bottom: 8px;">Email:</label>
            <input type="email" id="email" name="email" placeholder="Digite seu email"
                class="border placeholder:text-gray-500 border-white rounded-2xl p-3 w-500px focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <button id="capturar"
            class="bg-blue-600 hover:bg-green-400/20 rounded-lg py-3 px-4 text-gray-200 text-xl font-bold"
            style="left:160px; margin-right: 5px; width: 315px; margin-bottom: 8px;">Capturar Gesto</button>
        <a href="{% url 'signup' %}"
            class="text-center bg-blue-600 hover:bg-red-500/20 rounded-lg py-3 px-4 text-gray-200 text-xl font-bold"
            style="left:160px; margin-right: 5px; width: 315px; margin-bottom: 8px;">Voltar</a>

        <div>
            <h1 class="text-white text-x1 left-45">N√£o sabe como funciona?
                <a href="{% url 'help_gesto' %}" class="text-blue-700">Clique Aqui!</a>
            </h1>
        </div>

    </div>


    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

    <script>
        const csrftoken = '{{ csrf_token }}'

        const video = document.getElementById('video')
        const hands = new Hands({
            locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
        })

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        })

        let gestureData = null

        hands.onResults(results => {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                gestureData = results.multiHandLandmarks[0].map(p => [p.x, p.y, p.z])
            }
        })

        const camera = new Camera(video, {
            onFrame: async () => await hands.send({ image: video }),
            width: 400,
            height: 300
        })
        camera.start()

        document.getElementById("capturar").addEventListener("click", async () => {
            if (!gestureData) return alert("Nenhum gesto detectado!")

            const username = document.getElementById("username").value.trim()
            const email = document.getElementById("email").value.trim()
            if (!username || !email) return alert("Preencha todos os campos!")

            const response = await fetch("{% url 'salvar_gesto' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken
                },
                body: JSON.stringify({ username, email, keypoints: gestureData })
            })

            const data = await response.json()

            if (data.mensagem) {
                alert(data.mensagem)

                // üîπ Redireciona automaticamente para a tela de login ap√≥s 1.5 segundos
                setTimeout(() => {
                    window.location.href = "{% url 'login_gesto' %}"
                }, 1500)
            } else {
                alert(data.erro || "Erro ao salvar o gesto. Tente novamente.")
            }
        })
    </script>


</body>

{% endblock %}